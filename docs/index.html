<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>test api</title>
    <style>
        * {
            padding: 0;
            margin: 0;
            box-sizing: content-box;
        }
    </style>
</head>
<body>
    <button id="more">
        test
    </button>
    <main>
    </main>
    <script type="module">
        // import { graphql } from "https://cdn.skypack.dev/@octokit/graphql";
        // const fetchAll = async () => {
        //     let output = [];
        //     let hasNextPage = true;
        //     let after = null;
        //     while (hasNextPage) {
        //         const { repository: { issues } } = await graphql({
        //           query: `query lastIssues($owner: String!, $repo: String!, $num: Int = 100, $after: String) {
        //             repository(owner:$owner, name:$repo) {
        //               issues(first:$num, after:$after, orderBy:{field:CREATED_AT, direction:DESC}, filterBy:{createdBy:$owner}) {
        //                 pageInfo {
        //                     hasNextPage,
        //                     endCursor
        //                 }
        //                 nodes {
        //                   id,
        //                   title
        //                 }
        //               }
        //             }
        //           }`,
        //           owner: "9am",
        //           repo: "sample_app",
        //           after,
        //           headers: {
        //             authorization: `token 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`,
        //           },
        //         });
        //         hasNextPage = issues.pageInfo.hasNextPage;
        //         after = issues.pageInfo.endCursor;
        //         output = [...output, ...issues.nodes];
        //     }
        //     return output;
        // };

        // const list = await fetchAll();
        // console.log('all', list);

        const input = Array.from({ length: 5 }).map((_, i) => ({ id: i })).reverse();

        const paginate = (input = [], size = 2) => {
            const list = [...input];
            const totalCount = list.length;
            return Array
                .from({ length: Math.ceil(list.length / size) })
                .map((_, i) => i)
                .reduce(
                    (memo, pageNum) => {
                        const nodes = list.splice(0, size);
                        const [next = {}] = list;
                        return [
                            ...memo,
                            {
                                nodes,
                                totalCount,
                                pageInfo: {
                                    hasNextPage: !!next.id,
                                    endCursor: next.id,
                                },
                            }
                        ];
                    },
                    [],
                );
        };
        const list = paginate(input, 4);
        console.log(input, list);
    </script>
    <!--
    <script type="module" src="./js/imgVictor.js"></script>
    <script type="module">
        const loadMore = ({
            page = 1,
            perPage = 2
        }) => {
            return fetch(
                `https://api.github.com/repos/9am/sample_app/issues?creator=9am&per_page=${perPage}&page=${page}`,
                {
                    headers: [['Accept', 'application/vnd.github.v3+json']],
                },
            ).then(res => res.json());
        };

        const template = document.createElement('template');
        const tmp = ({ href, src }) => `
            <a href="${href}" target="_blank">
                <img-victor src="${src}"></img-victor>
            </a>
        `;
        const createItem = ({ body, html_url: url }) => {
            const file = body.match(/^(.+)\/([^\/\)]+)\)/)[2];
            template.innerHTML = tmp({
                href: url,
                src: `https://ik.imagekit.io/94av7hg7apo/${file}`,
            });
            return template.content.cloneNode(true);
        };

        (async () => {
            let currPage = 1;

            const main = document.querySelector('main');
            const btn = document.querySelector('#more');
            btn.addEventListener('click', async () => {
                try {
                    const result = await loadMore({ page: currPage });
                    console.log('loaded:', result);
                    if (result.length) {
                        const ele = result.reduce((container, data) => {
                            container.appendChild(createItem(data));
                            return container;
                        }, document.createDocumentFragment());
                        main.appendChild(ele);
                        currPage++;
                    } else {
                        btn.setAttribute('disabled', '');
                    }
                } catch (err) {
                    console.log('fail to load:', err);
                }
            });
        })();
    </script>
    -->
</body>
</html>

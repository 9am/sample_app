<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content=".">
    <meta name="keywords" content=".">
    <title>test api</title>
    <style>
        *, *::before, *::after {
          box-sizing: border-box;
        }
        * {
          margin: 0;
        }
        html, body {
          height: 100%;
        }
        body {
            background-color: #EFEEEE;
            // background-color: whitesmoke;
          line-height: 1.5;
          -webkit-font-smoothing: antialiased;
        }
        img, video, canvas, svg {
          display: block;
          max-width: 100%;
        }
        input, button, textarea, select {
          font: inherit;
        }
        p, h1, h2, h3, h4, h5, h6 {
          overflow-wrap: break-word;
        }
    </style>
    <style>
        a {
            cursor: pointer;
            // line-height: 2em;
            text-decoration: none;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: #EFEEEE;
            box-shadow: 6px 6px 16px rgb(217, 210, 200, 0.52),
                        -6px -6px 16px rgb(255, 255, 255, 0.84);
        }
        a:active:hover {
            box-shadow: inset 6px 6px 16px rgb(217, 210, 200, 0.52),
                        inset -6px -6px 16px rgb(255, 255, 255, 0.84);
        }
        main {
            display: flex;
            flex-wrap: wrap;
            color: #24292f;
        }
        .item {
            display: flex;
            flex-direction: column;
            flex: 0 0 50%;
            padding: 24px;
        }
        .item .victor {
            flex: 2 0;
        }
        .item .info {
            flex: 1 1;
        }
        .item img-victor {
            height: 100%;
            display: flex;
            align-items: center;
            padding: 4px;
        }
        @media (prefers-color-scheme: dark) {
            html {
                filter: invert(1) hue-rotate(.5turn);
            }
        }
        @media screen and (max-width: 1920px) {
            .item {
                flex: 0 0 25%;
            }
        }
        @media screen and (max-width: 1280px) {
            .item {
                flex: 0 0 33%;
            }
        }
        @media screen and (max-width: 960px) {
            .item {
                flex: 0 0 100%;
                flex-direction: row;
            }
        }
        @media screen and (max-width: 600px) {
            .item {
                flex: 0 0 100%;
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <main>
        <button id="more">
            test
        </button>
    </main>
    <script type="module">
        // import { graphql } from "https://cdn.skypack.dev/@octokit/graphql";
        // const fetchAll = async () => {
        //     let output = [];
        //     let hasNextPage = true;
        //     let after = null;
        //     while (hasNextPage) {
        //         const { repository: { issues } } = await graphql({
        //           query: `query lastIssues($owner: String!, $repo: String!, $num: Int = 100, $after: String) {
        //             repository(owner:$owner, name:$repo) {
        //               issues(first:$num, after:$after, orderBy:{field:CREATED_AT, direction:DESC}, filterBy:{createdBy:$owner}) {
        //                 pageInfo {
        //                     hasNextPage,
        //                     endCursor
        //                 }
        //                 nodes {
        //                   id,
        //                   title
        //                 }
        //               }
        //             }
        //           }`,
        //           owner: "9am",
        //           repo: "sample_app",
        //           after,
        //           headers: {
        //             authorization: `token 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`,
        //           },
        //         });
        //         hasNextPage = issues.pageInfo.hasNextPage;
        //         after = issues.pageInfo.endCursor;
        //         output = [...output, ...issues.nodes];
        //     }
        //     return output;
        // };

        // const list = await fetchAll();
        // console.log('all', list);

        // const input = Array.from({ length: 5 }).map((_, i) => ({ id: i })).reverse();

        // const paginate = (input = [], size = 2) => {
        //     const list = [...input];
        //     const totalCount = list.length;
        //     return Array
        //         .from({ length: Math.ceil(list.length / size) })
        //         .map((_, i) => i)
        //         .reduce(
        //             (memo, pageNum) => {
        //                 const nodes = list.splice(0, size);
        //                 const [next = {}] = list;
        //                 return [
        //                     ...memo,
        //                     {
        //                         nodes,
        //                         totalCount,
        //                         pageInfo: {
        //                             hasNextPage: !!next.id,
        //                             endCursor: next.id,
        //                         },
        //                     }
        //                 ];
        //             },
        //             [],
        //         );
        // };
        // const list = paginate(input, 4);
        // console.log(input, list);
    </script>
    <script type="module">
        import { ImageVictor } from '/js/imgVictor/index.js';

        const BASE = 'https://github.com/9am/sample_app';
        const IMG_PROXY = 'https://ik.imagekit.io/94av7hg7apo';
        const main = document.querySelector('#main');
        const moreBtn = document.querySelector('#more');

        const getNextPage = () => {
            const [lastItem] = [...document.querySelectorAll('.item')].slice(-1);
            return lastItem ? lastItem.dataset.next : 0;
        };

        const pending = (status = false) => {
            moreBtn.setAttribute('disabled', status);
        };

        const addItems = (child) => {
            main.insertBefore(child, moreBtn);
        };

        const template = document.createElement('template');
        const renderIssue = ({
            href,
            src,
            id,
            title,
            publishedAt,
            labels,
        }) => `
            <section id=${id} class="item">
                <a href="${href}" target="_blank">
                    <img-victor class="victor" src="${src}"></img-victor>
                </a>
                <div class="info">
                    <h2 class="title">${title}</h2>
                    <p class="date">${new Date(publishedAt).toDateString()}</p>
                    <div>${renderLables(labels)}</div>
                </div>
            </section>
        `;
        const renderLables = ({ nodes }) => nodes.map(({ name }) => `
            <a href="${BASE}/labels/${name}" target="_blank">${name}</a>
        `).join('');

        const createItem = ({ body, number, ...rest }) => {
            const file = body.match(/^(.+)\/([^\/\)]+)\)/)[2];
            template.innerHTML = renderIssue({
                href: `${BASE}/issues/${number}`,
                src: `${IMG_PROXY}/${file}`,
                ...rest,
            });
            return template.content.cloneNode(true);
        };

        const loadMore = async () => {
            pending(true);
            const page = getNextPage();
            const {
                nodes = [],
                pageInfo = {},
                totalCount = 0,
            } = await fetch(`/data/${page}.json`).then(res => res.json());
            const ele = nodes.reduce((container, data) => {
                container.appendChild(createItem({ ...data, next: pageInfo.nextPage }));
                return container;
            }, document.createDocumentFragment());
            addItems(ele);
            if (pageInfo.hasNextPage) {
                pending(false);
            }
        };


        try {
            const moreBtn = document.querySelector('#more');
            moreBtn.addEventListener('click', async () => await loadMore());
            await loadMore();
        } catch (err) {
            console.log('fail to load:', err);
        }
    </script>
    <!--
    -->
</body>
</html>

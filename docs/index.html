<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>test api</title>
    <style>
        * {
            padding: 0;
            margin: 0;
            box-sizing: content-box;
        }
    </style>
</head>
<body>
    <button id="more">
        test
    </button>
    <main>
    </main>
    <script type="module" src="./js/imgVictor.js"></script>
    <script type="module">
        const loadMore = ({
            page = 1,
            perPage = 2
        }) => {
            return fetch(
                `https://api.github.com/repos/9am/sample_app/issues?creator=9am&per_page=${perPage}&page=${page}`,
                {
                    headers: [['Accept', 'application/vnd.github.v3+json']],
                },
            ).then(res => res.json());
        };

        const template = document.createElement('template');
        const tmp = ({ href, src }) => `
            <a href="${href}" target="_blank">
                <img-victor src="${src}"></img-victor>
            </a>
        `;
        const createItem = ({ body, html_url: url }) => {
            const file = body.match(/^(.+)\/([^\/\)]+)\)/)[2];
            template.innerHTML = tmp({
                href: url,
                src: `https://ik.imagekit.io/94av7hg7apo/${file}`,
            });
            return template.content.cloneNode(true);
        };

        (async () => {
            let currPage = 1;

            const main = document.querySelector('main');
            const btn = document.querySelector('#more');
            btn.addEventListener('click', async () => {
                try {
                    const result = await loadMore({ page: currPage });
                    console.log('loaded:', result);
                    if (result.length) {
                        const ele = result.reduce((container, data) => {
                            container.appendChild(createItem(data));
                            return container;
                        }, document.createDocumentFragment());
                        main.appendChild(ele);
                        currPage++;
                    } else {
                        btn.setAttribute('disabled', '');
                    }
                } catch (err) {
                    console.log('fail to load:', err);
                }
            });
        })();
    </script>
</body>
</html>

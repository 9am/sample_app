<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content=".">
    <meta name="keywords" content=".">
    <title>test api</title>
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }
        * {
            margin: 0;
        }
        html, body {
            height: 100%;
        }
        body {
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        img, video, canvas, svg {
            display: block;
            max-width: 100%;
        }
        input, button, textarea, select {
            font: inherit;
        }
        p, h1, h2, h3, h4, h5, h6 {
            overflow-wrap: break-word;
        }
    </style>
    <style>
        #skip-to-main {
            position: absolute;
            top: -100%;
            background-color: black;
            color: white;
            display: block;
            width: 100%;
            text-align: center;
        }
        #skip-to-main:focus {
            top: 0;
        }
        .protruding {
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 6px 6px 16px rgb(217, 210, 200, 0.52),
                        -6px -6px 16px rgb(255, 255, 255, 0.84);
        }
        .button {
            cursor: pointer;
            text-decoration: none;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: #EFEEEE;
            box-shadow: 6px 6px 16px rgb(217, 210, 200, 0.52),
                        -6px -6px 16px rgb(255, 255, 255, 0.84);
        }
        .button:active:hover {
            box-shadow: inset 6px 6px 16px rgb(217, 210, 200, 0.52),
                        inset -6px -6px 16px rgb(255, 255, 255, 0.84);
        }
        .button svg {
            fill: dimgrey;
            stroke: none;
        }
        .button:active:hover svg {
            fill: none;
            stroke: dimgrey;
        }
        .link {
            padding: 8px 16px;
            color: #24292f;
        }
        body {
            display: flex;
            flex-direction: column;
            font-family: 'Helvetica Neue',
               'Arial Nova',
                Helvetica,
                Arial,
                sans-serif;
            background-color: #EFEEEE;
            color: #24292f;
        }
        header, footer {
            flex: 0 0 auto;
            position: relative;
            height: 200px;
            background-color: whitesmoke;
            text-align: center;
        }
        main {
            flex: 1 0 auto;
            display: flex;
            flex-wrap: wrap;
        }
        footer {
            margin-top: auto;
        }
        header .tile {
            position: relative;
            z-index: 1;
        }
        .logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: larger;
        }
        .item {
            display: flex;
            flex-direction: column;
            flex: 0 0 50%;
            padding: 24px;
        }
        .item > .button {
            flex: 2 0;
        }
        .item > .info {
            flex: 1 1;
            margin: 8px 0 0 0;
            position: relative;
        }
        .info::after {
            position: absolute;
            bottom: -24px;
            left: 0;
            width: 100%;
            height: 4px;
            border-radius: 2px;
            content: '';
            background-color: #EFEEEE;
            box-shadow: inset 1px 1px 2px rgb(217, 210, 200, 0.52),
                        inset -1px -1px 2px rgb(255, 255, 255, 0.84);
        }
        .item:last-child .info::after {
            visibility: hidden;
        }
        .item .victor {
            height: 100%;
            display: flex;
            align-items: center;
            padding: 4px;
            --victor-stroke: dimgrey;
        }
        .button > * {
            vertical-align: sub;
        }
        .icon {
            display: inline-block;
            width: 20px;
            height: 20px;
        }
        footer .button-group{
            position: absolute;
            bottom: 0;
            left: 0;
            display: flex;
            width: 100%;
        }
        .button-group .button {
            margin: 0 8px 8px 8px;
        }
        .button-group .button:last-child {
            margin-left: auto;
        }
        .button-group em {
            display: none;
        }
        @media (prefers-color-scheme: dark) {
            html {
                filter: invert(1) hue-rotate(.5turn);
            }
        }
        @media screen and (max-width: 1920px) {
            .item {
                flex: 0 0 25%;
            }
        }
        @media screen and (max-width: 1280px) {
            .item {
                flex: 0 0 33%;
            }
        }
        @media screen and (max-width: 960px) {
            .item {
                flex: 0 0 100%;
                flex-direction: row;
            }
            .item > .info {
                margin: 0 0 0 24px;
            }
        }
        @media screen and (max-width: 600px) {
            .item {
                flex: 0 0 100%;
                flex-direction: column;
            }
            .item > .info {
                margin: 8px 0 0 0;
            }
        }
    </style>
</head>
<body>
    <header id="top" class="protruding">
        <a id="skip-to-main" href="#main">Skip to main content</a>
        <shape-tile class="tile" title="9am"></shape-tile>
        <h1 class="logo">
            9am
        </h1>
    </header>
    <main id="main">
        <article class="item">
            <button id="more" class="button">
                MORE
            </button>
            <section class="info"></section>
        </article>
    </main>
    <footer class="protruding">
        <shape-tile class="tile"></shape-tile>
        <div class="button-group">
            <a class="button link" href="mailto:test@gmail.com">
                <svg class="icon" focusable="false" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"></path>
                </svg>
                <em>email</em>
            </a>
            <a class="button link" href="https://github.com/9am/sample_app/issues">
                <svg class="icon" focusable="false" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 .3a12 12 0 0 0-3.8 23.4c.6.1.8-.3.8-.6v-2c-3.3.7-4-1.6-4-1.6-.6-1.4-1.4-1.8-1.4-1.8-1-.7.1-.7.1-.7 1.2 0 1.9 1.2 1.9 1.2 1 1.8 2.8 1.3 3.5 1 0-.8.4-1.3.7-1.6-2.7-.3-5.5-1.3-5.5-6 0-1.2.5-2.3 1.3-3.1-.2-.4-.6-1.6 0-3.2 0 0 1-.3 3.4 1.2a11.5 11.5 0 0 1 6 0c2.3-1.5 3.3-1.2 3.3-1.2.6 1.6.2 2.8 0 3.2.9.8 1.3 1.9 1.3 3.2 0 4.6-2.8 5.6-5.5 5.9.5.4.9 1 .9 2.2v3.3c0 .3.1.7.8.6A12 12 0 0 0 12 .3"></path>
                </svg>
                <em>github</em>
            </a>
            <a class="button link" href="./assets/data/rss.xml">
                <svg class="icon" focusable="false" viewBox="0 0 24 24" aria-hidden="true">
                    <circle cx="6.18" cy="17.82" r="2.18"></circle>
                    <path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"></path>
                </svg>
                <em>rss</em>
            </a>
            <a class="button link" href="#top">
                <svg class="icon" focusable="false" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M5 4v2h14V4H5zm0 10h4v6h6v-6h4l-7-7-7 7z"></path>
                </svg>
                <em>top</em>
            </a>
        </div>
    </footer>
    <script type="module">
        import { ImageVictor } from './assets/js/imgVictor/index.js';
        import { Tile } from './assets/js/shapeTile/index.js';

        const BASE = 'https://github.com/9am/sample_app';
        const IMG_PROXY = 'https://ik.imagekit.io/94av7hg7apo';
        const main = document.querySelector('#main');
        const moreBtn = document.querySelector('#more');

        const getNextPage = () => {
            const [lastItem] = [...document.querySelectorAll('.item')].slice(-2, -1);
            return lastItem ? lastItem.dataset.next : 0;
        };

        const pending = (status = false) => {
            if (status) {
                moreBtn.textContent = '......';
                moreBtn.setAttribute('disabled', '');
            } else {
                moreBtn.textContent = 'MORE';
                moreBtn.removeAttribute('disabled');
            }
        };

        const addItems = (child) => {
            main.insertBefore(child, moreBtn.parentNode);
        };

        const template = document.createElement('template');
        const renderIssue = ({
            href,
            src,
            title,
            desc,
            publishedAt,
            labels,
            next,
        }) => `
            <article class="item" data-next="${next}">
                <a class="button" href="${href}" target="_blank">
                    <img-victor class="victor" data-src="${src}"></img-victor>
                </a>
                <section class="info">
                    <h2 class="title">${title}</h2>
                    <time class="date" datetime="${publishedAt}">${new Date(publishedAt).toDateString()}</time>
                    <p class="desc">${desc}</p>
                    <div>${renderLabels(labels)}</div>
                </section>
            </article>
        `;
        const renderLabels = ({ nodes }) => nodes.map(({ name }) => `
            <a class="button" href="${BASE}/labels/${name}" target="_blank">${name}</a>
        `).join('');

        const createItem = ({ body, number, ...rest }) => {
            const file = body.match(/<img src=.*\/([^\/]+\.\w{3,4})/)[1];
            const desc = body.match(/<mark>(.*)<\/mark>/)[1];
            template.innerHTML = renderIssue({
                href: `${BASE}/issues/${number}`,
                src: `${IMG_PROXY}/${file}`,
                desc,
                ...rest,
            });
            return template.content.cloneNode(true);
        };

        const loadMore = async () => {
            pending(true);
            const page = getNextPage();
            const {
                nodes = [],
                pageInfo = {},
                totalCount = 0,
            } = await fetch(`./assets/data/${page}.json?rid=${Math.random()}`).then(res => res.json());
            const ele = nodes.reduce((container, data) => {
                container.appendChild(createItem({ ...data, next: pageInfo.nextPage }));
                return container;
            }, document.createDocumentFragment());
            addItems(ele);
            if (pageInfo.hasNextPage) {
                pending(false);
            }
            active();
        };

        const inViewport = (el, percent = 0.2) => {
            if (!el) {
                return false;
            }
            const { top, height } = el.getBoundingClientRect();
            return (top >= 0
                && (top + height * percent) <= (window.innerHeight || document.documentElement.clientHeight)
            );
        };

        const active = () => {
            const victors = [...document.querySelectorAll('.victor[data-src]')];
            victors.forEach(victor => {
                if (inViewport(victor)) {
                    victor.src = victor.dataset.src;
                    delete victor.dataset.src;
                }
            });
        };

        const throttle = (fn, delay = 500) => {
            let timer = null;
            return (...args) => {
                if (timer) {
                    return;
                }
                timer = setTimeout(() => {
                    fn(args);
                    timer = null;
                }, delay);
            };
        };

        (async () => {
            const onActive = throttle(active);
            moreBtn.addEventListener('click', loadMore);
            window.addEventListener('scroll', onActive);
            window.addEventListener('resize', onActive);
            try {
                // await loadMore();
            } catch (err) {
                console.log('fail:', err);
            }
            [...document.querySelectorAll('.tile')].forEach(tile => {
                const edge = Math.floor(Math.random() * 12 + 3);
                tile.edge = edge > 9 ? 0 : edge;
            });
        })();
    </script>
</body>
</html>
